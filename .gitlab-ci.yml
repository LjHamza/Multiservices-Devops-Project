image: docker:latest

services:
  - docker:dind

stages:
- Build
- Test
- Create Docker Image
- Push Docker Image

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  CACHE_KEY: $CI_COMMIT_REF_SLUG


cache:
  key: $CACHE_KEY
  paths:
   - .m2/repository

include:
  - local: clientui/.gitlab-ci.yml
  - local: microservice-commandes/.gitlab-ci.yml
  - local: microservice-paiement/.gitlab-ci.yml
  - local: microservice-produits/.gitlab-ci.yml


.test-module:
  image: maven:3.8.4-jdk-8
  stage: Test
  script:
   - echo "Testing $MODULE"
   - mvn $MAVEN_CLI_OPTS -pl $MODULE test --also-make

.build-module:
  image: maven:3.8.4-jdk-8
  stage: Build
  script:
  - echo "Building $MODULE"
  - mvn -pl $MODULE clean package --also-make
  artifacts:
    paths:
    - "*/target"

.create-image:
  stage: Create Docker Image
  script:
    - echo "Creating Docker Images"
    - docker build -t h4mz4/$MODULE:1.0 ./$MODULE

.push-image:
  stage: Push Docker Image
  before-script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASS" $CI_REGISTRY
  script:
    - echo "Pushing Docker Images"
    - docker push h4mz4/$MODULE

# BUILD JOBS
build-clientui-module:
  extends:
  - .clientui-module
  - .build-module

build-commande-module:
  extends:
  - .commande-module
  - .build-module

build-paiement-module:
  extends:
  - .paiement-module
  - .build-module

build-produit-module:
  extends:
  - .produit-module
  - .build-module

# TEST JOBS

test-clientui-module:
  extends:
  - .clientui-module
  - .test-module

test-commande-module:
  extends:
  - .commande-module
  - .test-module

test-paiement-module:
  extends:
    - .paiement-module
    - .test-module

test-produit-module:
  extends:
   - .produit-module
   - .test-module


# Create Docker Image

create-clientui-image:
  extends:
    - .clientui-module
    - .create-image

create-commande-image:
  extends:
    - .commande-module
    - .create-image

create-paiement-image:
  extends:
    - .paiement-module
    - .create-image
create-produit-image:
  extends:
    - .produit-module
    - .create-image

# Push Docker Image

push-clientui-image:
  extends:
    - .clientui-module
    - .push-image

push-commande-image:
  extends:
    - .commande-module
    - .push-image

push-paiement-image:
  extends:
    - .paiement-module
    - .push-image
push-produit-image:
  extends:
    - .produit-module
    - .push-image